---
name: Publish artifacts

on:
  release:
    types: [published] # Triggers AFTER release-please creates the tag/release

env:
  GO_VERSION: 1.24.3
  GORELEASER_VERSION: '~> v2'

permissions:
  contents: write
  issues: write
  id-token: write

jobs:
  release:
    runs-on: prod-linux-l
    steps:
      - name: Checkout repository
        uses: doctolib/actions/checkout@429fae9c3fefa82b9a7fc0223edfaecc7234c787 # checkout-v0.1.0
        with:
          fetch-depth: 0

      - name: Load Secrets
        uses: doctolib/actions/load-secrets@main
        with:
          prefix_secrets: true

      - name: Setup go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: false

      - name: Generate github token for doctolib/homebrew-yak
        id: githubtoken
        shell: bash
        run: |
          token=$(.github/generate-token-from-github-app.sh ${{ env.VAULT_SECRET_HOMEBREW_TAP_GITHUB_APP_ID }} "${{ env.VAULT_SECRET_HOMEBREW_TAP_GITHUB_PRIVATE_KEY }}" doctolib/homebrew-yak doctolib/homebrew-doctolib)
          echo "token=${token}" >> "$GITHUB_OUTPUT"

      - name: Login on aws ecr
        uses: doctolib/actions/docker-login@main
        with:
          aws_iam_role: arn:aws:iam::580698825394:role/gha_${{ github.event.repository.name }}_br_all
          aws_iam_region: 'eu-central-1'

      - name: Configure buildx for multi-arch
        run: docker buildx rm multiarch || true; docker buildx create --use --name multiarch

      - name: Execute goreleaser for releases
        uses: goreleaser/goreleaser-action@9c156ee8a17a598857849441385a2041ef570552 # v6
        with:
          distribution: goreleaser
          version: ${{ env.GORELEASER_VERSION }}
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ github.token }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ steps.githubtoken.outputs.token }}
          SLACK_WEBHOOK: ${{ env.VAULT_SECRET_GORELEASER_SLACK_WEBHOOK_URL }}
